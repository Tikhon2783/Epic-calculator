# "Распределенный вычислитель арифметических выражений"

## Оглавление readme
1. Что реализовано + контакты
1. Как запускать
    * Что установить
    * Как пользоваться
    * Что и как можно ломать
1. Примеры
1. Документация
    1. Как все работает
    2. Логгеры
    3. Ошибки

### Что реализовано 
Я постарался реализовать все, кроме фронтенда, делить выражение и отправлять нескольким агентам тоже не получилось. Если есть какие-то вопросы, что-то не работает или у меня где-то ошибки — мой телеграмм @Tikhon1111 (я есть в чате курса)

#### Общий принцип работы
Калькулятор состоит из 3 частей - оркестратора, агентов и вычислителей. Оркестратор контролирует http сервер и управляет агентами, отправляя им выражения. Агенты представленны горутинами, однако, насколько возможно, имитируют что-то наподобии отдельных серверов. У агента есть горутины-вычислители, которые только умеют считать простейшие операции (a+b a-b a*b a/b), "спать" и отправлять результат агенту. Агент, когда получает выражение, превращает его в набор таких простых операций и организовывает работу вычислителей, а потом возвращает результат оркестратору.   
  Подробнее об этом в пункте 4 (документация) - "как все работает".

#### Реализация
Программа должна переживать перезапуск, поэтому значения, связанные с выражениями хранятся в базе данных PostgreSQL.

   При первом запуске подготавливается БД — создаются необходимые хранилища (таблицы).  
   Потом запускается оркестратор: сначала он запускает агентов, потом горутину мониторинга агентов, и, наконец, http сервер.  
   На один endpoint сервера пользователь отправляет запрос с выражением и ключом
   идемпотентности, оркестратор проверяет его и возвращает код (200, 400, 500). Если все хорошо, передает выражение агенту и ожидает дальнейших событий. Ошибку деления на ноль получает вычислитель и передает агенту, который сразу сообщает об этом оркестратору, не досчитывая выражения. Поддерживаются +, -, *, /, скобки не поддерживаются. Унарный минус нельзя ставить перед другим минусов, операция сложения с отрицательным числом считается за операцию вычитания.  
   Существуют также endpoint-ы для получения статуса/результата выражения по ключу идемпотентности, для получения списка таких статусов для всех выражений, получения и изменения времени на выполнение простейших операций и таймаутов для агентов (насколько долго агент может считаться живым, не посылая хартбиты). Есть еще endpoint-ы для получения статусов агентов (интерфейс мониторинга воркеров) и для "убийства" различных компонентов калькулятора — оркестратора или агентов.

   Я у себя проверял, выражения вроде все считаются правильно, критичных ошибок возникать не должно.

   Для завершения работы можно убить оркестратора или просто отправить сигнал прерывания ^C – программа его распознает, закроет все, что было открыто и завершит работу. Если по какой-то причине оба варианта не сработают, придется открывать диспетчер задач, искать процесс startup.go и завершать его. Скриншот примера будет приложен. У меня такая проблема возникала только в самом начале, ^C сработает в 99% случаев. Если все-таки у вас возникнет эта ошибка, пожалуйста, напишите мне, чтобы я поправил, а вы и следующие проверяющие не страдали.


### Как запускать

#### Что устанавливать
Установить нужно только базу данных PostgreSQL. Я устанавливал здесь: https://www.enterprisedb.com/downloads/postgres-postgresql-downloads. Версия 16, для windows 64.

Использованные библиотеки: "github.com/jackc/pgx", "github.com/jackc/pgx/v5", "github.com/jackc/pgx/v5/stdlib"

#### Как пользоваться
Для начала нужно установить несколько переменных в vars/variablables.go: главное задать константы для работы Postgres, в комментариях они подписаны. Порт по умолчанию '5432', имя пользователя задается при установке БД, по умолчанию "postgres", если я не ошибаюсь. Пароль тоже задается при установке. DBName можно указать любое, главное чтобы базы с таким названием уже не было. DBNameDefault - база, к которой по умолчанию подключается пользователь, обычно "postgres".  
  В файле variables.go можно изменять любые переменные. Флаги логгеров не советую менять, потому что логгеры хартбитов и дебага выводят много информации, будут засорять консоль. В остальных файлах лучше ничего не менять) по крайней мере я этого не предусматривал, может все сломаться.  
  HTTP порт используется 8080, если что, его можно изменить на 334 строчке файла backend/cmd/orchestrator/orchestrator.go

Перед первым запуском надо проверить, что в файле vars/db_existance.json все значения — false. Команда для запуска калькулятора: 'go run cmd/startup/startup.go'. После того, как запустится сервер, в консоле будет сообщение 'Калькулятор готов к работе!'. После этого можно будет посылать запросы. Я постараюсь сделать удобный интерфейс для консоли вместо curl-ов к понедельнику. Чистые запросы описаны в quick_directories.txt в абзацах с curl-ами, их можно отправлять из терминала (нужно открыть новый, не тот, в котором запущен калькулятор) и получать ответы.

#### Что и как можно ломать
Оркестратор и агент поддерживают имитацию перезапуска. Для этого есть endpoint-ы calculator/kill/agent и calculator/kill/orchestrator.  
   Убивая оркестратора, программа сразу отключает сервер и завершает работу. При повторном запуске, оркестратор проверяет на наличие в БД непосчитанных выражений и направляет их агентам — ничего потеряно не будет.  
   Можно убить агента: оркестратор отменит его контекст, после чего горутина агента выйдет, а оркестратор узнает о смерти потому, что агент перестанет посылать хартбиты. (мониторинг воркеров получается)  
   Отдельно вычислителей убивать не получится, да и смысла в этом нет.


### Примеры
Опять же, "интерфейс" добавлю к утру понедельника, пока можно отправлять запросы curl, какие именно и примеры в файле quick_directories.txt

Таблица с символами, которые нужно заменять в выражении  
| символ | на что менять |
|:-------|:-------------:|
|+       |    %2B |
|-       |     -  |
|/       |    %2F |
|*       |    %2A |


### Документация

#### Принцип работы
